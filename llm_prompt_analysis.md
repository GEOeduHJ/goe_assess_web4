# LLM 프롬프트 분석 및 최적화 제안

## 개요

이 문서는 지리 자동 채점 시스템에서 LLM(Gemini/Groq)에게 보내는 프롬프트의 전체 분량을 분석한 결과입니다. 프롬프트가 과도하게 길어지는 문제를 식별하고 최적화 방향을 제안합니다.

## 프롬프트 구조 분석

LLM 프롬프트는 다음과 같은 구성 요소로 이루어집니다:

### 1. 시스템 역할 정의
- **길이**: 약 50-70자
- **내용**: "당신은 지리 교과목 전문 채점자입니다. 학생의 서술형 답안을 분석하여 채점해주세요."

### 2. 참고 자료 (RAG 검색 결과)
- **길이**: 최대 3개 × 300자 = 900자 (최적화 적용 후)
- **내용**: 교과서나 참고 자료에서 검색된 관련 텍스트 청크들 (최대 3개)
- **형식**: "참고자료 1: [텍스트...]\n참고자료 2: [텍스트...]"
- **최적화**: 각 청크 300자로 제한, 최대 3개로 제한

### 3. 평가 루브릭
- **길이**: 평가 요소 수에 비례 (약 100-500자)
- **내용**: 각 평가 요소의 이름, 최대 점수, 채점 기준들
- **형식**: "평가요소: [이름] (최대 X점)\n  X점: [기준]\n  Y점: [기준]..."

### 4. 학생 답안
- **길이**: 학생 답안 길이에 비례 (약 100-1000자)
- **내용**: 학생이 작성한 텍스트 답안

### 5. 출력 형식 지정
- **길이**: 고정 (약 200-300자)
- **내용**: JSON 형식의 출력 요구사항 명시

## 예시 프롬프트 (서술형 채점)

```
당신은 지리 교과목 전문 채점자입니다. 학생의 서술형 답안을 분석하여 채점해주세요.

다음은 채점 참고 자료입니다:
참고자료 1: 한국의 수도는 서울이다. 서울은 경기도에 둘러싸인 특별시로, 인구 약 1,000만 명을 수용하는 대도시이다.
참고자료 2: 한국은 동아시아에 위치한 반도 국가로, 북한과 중국, 러시아와 국경을 접하고 있다. 동쪽으로는 일본이 있으며, 동해와 남해, 서해로 둘러싸여 있다.
참고자료 3: 한국의 주요 산업은 제조업, 정보통신업, 금융업 등이다. 특히 반도체, 자동차, 조선 등은 세계적으로 경쟁력이 있다.

다음은 평가 루브릭입니다:

평가요소: 위치 정확도 (최대 2점)
  2점: 정확한 위치 표시
  1점: 대략적인 위치 표시
  0점: 위치 표시 없음

평가요소: 레이블 완전성 (최대 2점)
  2점: 명확한 레이블
  1점: 일부 레이블
  0점: 레이블 없음

다음은 학생 답안입니다:
서울은 한국의 수도이며, 인구는 약 1천만 명이다. 경기도에 둘러싸여 있으며, 주요 산업으로는 제조업과 금융업이 있다.

다음 JSON 형식으로 채점 결과를 제공해주세요:
{
  "scores": {
    "위치 정확도": 점수, "레이블 완전성": 점수
  },
  "reasoning": {
    "위치 정확도": "점수 부여 근거", "레이블 완전성": "점수 부여 근거"
  },
  "feedback": "학생을 위한 개선 피드백",
  "total_score": 4
}

중요: 반드시 위의 JSON 형식을 정확히 따라주세요. 각 평가요소에 대해 루브릭에 명시된 점수만 부여하세요.
```

## 길이 분석

### 현재 예시 프롬프트 (최적화 적용 후)
- **총 문자 수**: 1,471자
- **예상 토큰 수**: 약 367토큰 (1토큰 ≈ 4자 기준)
- **Gemini API 제한**: 1M 토큰 (입력+출력)
- **Groq API 제한**: 모델에 따라 4K-128K 토큰

### 최적화 결과
- ✅ RAG 청크 사이즈를 300자로 제한
- ✅ 최대 3개의 참고 자료로 제한
- ✅ 전체 프롬프트가 1,500자 이하로 유지됨

### 잠재적 문제점

1. **RAG 참고 자료의 과도한 포함**
   - 교과서 PDF에서 추출된 텍스트 청크가 길어질 수 있음
   - 검색 결과가 5-10개 이상일 경우 프롬프트가 2000자 이상으로 증가

2. **평가 루브릭의 확장**
   - 평가 요소가 5-10개 이상일 경우 루브릭 부분만 1000자 이상

3. **학생 답안 길이**
   - 긴 서술형 답안의 경우 1000자 이상

4. **토큰 제한 초과 가능성**
   - Gemini의 경우 1M 토큰으로 넉넉하지만, 비용과 응답 속도 고려
   - Groq의 일부 모델은 4K-8K 토큰 제한

## 최적화 제안

### 1. RAG 참고 자료 최적화 ✅ **구현 완료**
- **검색 결과 수 제한**: 최대 3개의 청크로 제한
- **청크 길이 제한**: 각 청크를 300자로 제한 (초과 시 "..."으로 잘라냄)
- **관련성 필터링**: 학생 답안과의 유사도 기반 자동 선택

### 2. 프롬프트 구조 개선
- **참고 자료 위치 조정**: 학생 답안 다음에 배치하여 맥락 유지
- **중복 제거**: 유사한 참고 자료 자동 제거
- **메타데이터 활용**: 청크 출처 정보 간소화

### 3. 동적 프롬프트 생성
- **토큰 수 모니터링**: 생성 시점에 토큰 수 계산
- **우선순위 기반 포함**: 중요도에 따라 내용 선택적 포함
- **청크 선택 알고리즘**: 학생 답안과의 유사도 기반 자동 선택

### 4. 캐싱 및 재사용
- **프롬프트 템플릿 캐싱**: 유사한 루브릭에 대한 프롬프트 재사용
- **참고 자료 그룹화**: 동일한 주제의 참고 자료 미리 그룹화

### 5. 모델별 최적화
- **Gemini**: 긴 프롬프트 허용, 이미지+텍스트 동시 처리
- **Groq**: 짧은 프롬프트 선호, 텍스트 전용

## 구현 우선순위

1. **긴급**: RAG 검색 결과 수 제한 (3개로) ✅ **완료**
2. **중요**: 각 청크 길이 제한 (300자) ✅ **완료**
3. **보통**: 토큰 수 모니터링 기능 추가
4. **저우선**: 프롬프트 템플릿 캐싱

## 결론

현재 프롬프트는 기본적인 경우에 적절한 길이지만, RAG 참고 자료의 양이 증가함에 따라 문제가 될 수 있었습니다. **구현된 최적화**를 통해 프롬프트 길이를 1000자 내외로 유지하면서도 채점 품질을 보장할 수 있게 되었습니다. 각 청크를 300자로 제한하고 최대 3개로 제한함으로써 LLM 입력 제한을 효과적으로 피할 수 있습니다.
